<section class="project-details-page">
  <a routerLink="/projects" class="back-link">
    <mat-icon>chevron_left</mat-icon>
    {{ 'COMMON.ACTIONS.BACK_TO_PROJECTS' | translate }}
  </a>

  <section *ngIf="loading()" class="loading-shell">
    <mat-icon>hourglass_top</mat-icon>
    <p>{{ 'PROJECTS.DETAILS.LOADING' | translate }}</p>
  </section>

  <ng-container *ngIf="!loading() && project() as currentProject">
    <header class="details-header">
      <div class="header-copy">
        <p class="project-key">{{ currentProject.key }}</p>
        <h1>{{ currentProject.name }}</h1>

        <div class="meta-row">
          <app-project-status-badge [status]="currentProject.status" />
          <span>{{ 'PROJECTS.META.OWNER' | translate }}: {{ currentProject.owner }}</span>
          <span>{{ 'PROJECTS.META.DUE' | translate }}: {{ currentProject.dueDate | date: 'MMM d, y' : undefined : locale() }}</span>
          <span>{{ 'PROJECTS.DETAILS.BUDGET' | translate }}: {{ currentProject.budget }}</span>
        </div>
      </div>

      <div class="header-actions">
        <button type="button" class="secondary-btn" (click)="openArchiveModal()">
          {{ 'COMMON.ACTIONS.ARCHIVE' | translate }}
        </button>
        <button type="button" class="primary-btn" (click)="setActiveTab('settings')">
          {{ 'COMMON.ACTIONS.EDIT' | translate }}
        </button>
      </div>
    </header>

    <nav class="tab-nav">
      <button
        type="button"
        *ngFor="let tab of tabs"
        [ngClass]="{ active: activeTab() === tab.key }"
        (click)="setActiveTab(tab.key)"
      >
        {{ tab.labelKey | translate }}
      </button>
    </nav>

    <section class="tab-host" [@tabSwitchAnimation]="activeTab()">
      <article class="tab-pane" *ngIf="activeTab() === 'overview'">
        <section class="stats-grid">
          <article>
            <p>{{ 'PROJECTS.DETAILS.STATS.COMPLETION' | translate }}</p>
            <h3>{{ currentProject.completionRate }}%</h3>
          </article>
          <article>
            <p>{{ 'PROJECTS.DETAILS.STATS.OPEN_TASKS' | translate }}</p>
            <h3>{{ currentProject.openTasks }}</h3>
          </article>
          <article>
            <p>{{ 'PROJECTS.DETAILS.STATS.SPRINT' | translate }}</p>
            <h3>{{ currentProject.sprint }}</h3>
          </article>
          <article>
            <p>{{ 'PROJECTS.DETAILS.STATS.PRODUCTIVITY' | translate }}</p>
            <h3>{{ 'PROJECTS.META.PRODUCTIVITY_POINTS' | translate: { value: currentProject.productivity } }}</h3>
          </article>
        </section>

        <section class="panel">
          <header>
            <h3>{{ 'PROJECTS.DETAILS.MILESTONES' | translate }}</h3>
          </header>

          <article class="milestone" *ngFor="let milestone of currentProject.milestones; trackBy: trackByMilestone">
            <div>
              <h4>{{ milestone.name }}</h4>
              <p>{{ milestone.dueDate | date: 'MMM d, y' : undefined : locale() }}</p>
            </div>

            <div class="completion-pill">{{ milestone.completion }}%</div>
          </article>
        </section>
      </article>

      <article class="tab-pane" *ngIf="activeTab() === 'team'">
        <section class="panel team-panel">
          <header>
            <h3>{{ 'PROJECTS.DETAILS.TEAM_CAPACITY' | translate }}</h3>
          </header>

          <article class="member-row" *ngFor="let member of currentProject.teamMembers; trackBy: trackByMember">
            <div class="avatar">{{ member.initials }}</div>
            <div>
              <h4>{{ member.name }}</h4>
              <p>{{ member.role }}</p>
            </div>
            <span>{{ member.allocation }}</span>
          </article>
        </section>
      </article>

      <article class="tab-pane" *ngIf="activeTab() === 'settings'">
        <section class="panel settings-panel">
          <header class="settings-head">
            <div>
              <h3>{{ 'PROJECTS.DETAILS.SETTINGS.TITLE' | translate }}</h3>
              <p>{{ 'PROJECTS.DETAILS.SETTINGS.SUBTITLE' | translate }}</p>
            </div>

            <p class="autosave-chip" [ngClass]="autosaveState()">
              {{ autosaveStateLabelKey(autosaveState()) | translate }}
              <span *ngIf="lastSaved()">{{ 'PROJECTS.DETAILS.AUTOSAVE.AT' | translate: { time: lastSaved() } }}</span>
            </p>
          </header>

          <form class="settings-form" [formGroup]="settingsForm" (ngSubmit)="saveSettingsNow()" novalidate>
            <div class="field-grid">
              <label>
                <span>{{ 'PROJECTS.FIELDS.PROJECT_NAME' | translate }}</span>
                <input type="text" formControlName="name" />
                <p class="form-error" *ngIf="hasControlError('name')" [@formErrorAnimation]>
                  {{ controlErrorText('name') | translate }}
                </p>
              </label>

              <label>
                <span>{{ 'PROJECTS.FIELDS.OWNER' | translate }}</span>
                <input type="text" formControlName="owner" />
                <p class="form-error" *ngIf="hasControlError('owner')" [@formErrorAnimation]>
                  {{ controlErrorText('owner') | translate }}
                </p>
              </label>

              <label>
                <span>{{ 'PROJECTS.FIELDS.DUE_DATE' | translate }}</span>
                <input type="date" formControlName="dueDate" />
                <p class="form-error" *ngIf="hasControlError('dueDate')" [@formErrorAnimation]>
                  {{ controlErrorText('dueDate') | translate }}
                </p>
              </label>

              <label>
                <span>{{ 'PROJECTS.FIELDS.STATUS' | translate }}</span>
                <select formControlName="status">
                  <option *ngFor="let status of statusOptions" [value]="status">{{ statusLabelKey(status) | translate }}</option>
                </select>
              </label>
            </div>

            <label>
              <span>{{ 'PROJECTS.FIELDS.SUMMARY' | translate }}</span>
              <textarea rows="3" formControlName="summary"></textarea>
              <p class="form-error" *ngIf="hasControlError('summary')" [@formErrorAnimation]>
                {{ controlErrorText('summary') | translate }}
              </p>
            </label>

            <label>
              <span>{{ 'PROJECTS.DETAILS.SETTINGS.DESCRIPTION' | translate }}</span>
              <textarea rows="5" formControlName="description"></textarea>
              <p class="form-error" *ngIf="hasControlError('description')" [@formErrorAnimation]>
                {{ controlErrorText('description') | translate }}
              </p>
            </label>

            <div class="actions-row">
              <button type="button" class="secondary-btn" (click)="resetSettings()">{{ 'COMMON.ACTIONS.RESET' | translate }}</button>
              <button type="submit" class="primary-btn">{{ 'COMMON.ACTIONS.SAVE_NOW' | translate }}</button>
            </div>
          </form>
        </section>
      </article>
    </section>
  </ng-container>
</section>

<app-project-modal
  *ngIf="archiveModalOpen()"
  [title]="'PROJECTS.DETAILS.ARCHIVE_MODAL.TITLE' | translate"
  [subtitle]="'PROJECTS.DETAILS.ARCHIVE_MODAL.SUBTITLE' | translate"
  (closed)="closeArchiveModal()"
>
  <p class="archive-copy">
    {{ 'PROJECTS.DETAILS.ARCHIVE_MODAL.DESCRIPTION' | translate }}
  </p>

  <div class="actions-row">
    <button type="button" class="secondary-btn" (click)="closeArchiveModal()">{{ 'COMMON.ACTIONS.CANCEL' | translate }}</button>
    <button type="button" class="danger-btn" (click)="archiveProject()">{{ 'PROJECTS.DETAILS.ARCHIVE_MODAL.CONFIRM' | translate }}</button>
  </div>
</app-project-modal>
